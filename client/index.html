<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lakdi - Multiplayer Card Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root{
      --bg1:#1a4f3a; --bg2:#0d2818; --gold:#ffd700; --panel:rgba(255,255,255,.08);
      --panel-b:rgba(255,255,255,.15); --muted:rgba(255,255,255,.6);
      --btn-red:#ee5a24; --btn-blue:#4f46e5; --btn-green:#2ecc71;
      --card-b:#cbd5e1;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
         background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;overflow:hidden}

    .connection-status{position:fixed;top:16px;left:16px;padding:10px 14px;border-radius:12px;
      background:rgba(46,204,113,.16);border:1px solid #2ecc71;color:#2ecc71;font-weight:700;z-index:50}

    /* Lobby */
    .login-wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
    .login-card{width:min(560px,92vw);background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);
      border-radius:22px;padding:32px 28px;box-shadow:0 12px 22px rgba(0,0,0,.25)}
    .brand{display:flex;justify-content:center;align-items:center;gap:14px;margin-bottom:22px}
    .brand .logo{width:46px;height:46px;border-radius:10px;background:var(--gold)}
    .brand .title{font-size:48px;font-weight:900;color:var(--gold)}
    .field{margin:12px 0}
    .input{width:100%;padding:14px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.28);
      background:rgba(255,255,255,.08);color:#fff;font-size:16px;outline:none}
    .input::placeholder{color:var(--muted)}
    .button{width:100%;padding:16px 18px;border:none;border-radius:14px;color:#fff;font-weight:900;
      letter-spacing:.2px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;
      box-shadow:0 8px 18px rgba(0,0,0,.2);transition:transform .1s ease}
    .button:active{transform:translateY(1px)}
    .btn-join{background:linear-gradient(45deg,#ff6b6b,var(--btn-red))}
    .btn-create{background:linear-gradient(45deg,#4834d4,var(--btn-blue))}
    .btn-cpu{background:linear-gradient(45deg,#27ae60,var(--btn-green))}
    .stack{display:grid;gap:14px;margin-top:10px}

    /* Game table */
    .game-container{height:100%;display:flex;flex-direction:column;position:relative}
    .scoreboard{position:absolute;top:20px;right:20px;background:rgba(0,0,0,.85);backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:18px 16px;min-width:240px;z-index:5}
    .scoreboard h3{margin:0 0 10px;color:var(--gold);text-align:center}
    .score-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:8px;
      margin:6px 0;background:rgba(255,255,255,.06)}
    .score-item.winner{background:rgba(46,204,113,.28)}

    .game-table{flex:1;display:flex;align-items:center;justify-content:center;position:relative;padding:22px}
    .players-container{position:absolute;inset:0}
    .player-seat{position:absolute;display:flex;flex-direction:column;align-items:center;gap:10px;min-width:120px}
    .player-seat.active{animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.75}}
    .player-info{background:var(--panel);border:1px solid var(--panel-b);border-radius:14px;padding:10px 14px;text-align:center}
    .player-name{font-weight:800;margin-bottom:4px}
    .player-score{font-size:14px;color:var(--gold)}
    .player-cards{display:flex;gap:6px}
    .card-back{width:30px;height:42px;border-radius:6px;background:linear-gradient(135deg,#2c3e50,#34495e);border:1px solid #3498db}
    .seat-top{top:8%;left:50%;transform:translateX(-50%)}
    .seat-r1{top:20%;right:10%}
    .seat-r2{top:50%;right:5%;transform:translateY(-50%)}
    .seat-b1{bottom:20%;right:10%}
    .seat-l1{bottom:20%;left:10%}
    .seat-l2{top:50%;left:5%;transform:translateY(-50%)}

    .table-center{position:relative;display:flex;align-items:center;justify-content:center;gap:20px}
    .pile{width:90px;height:120px;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:transform .12s ease;font-weight:700}
    .pile:hover{transform:scale(1.05)}
    .stock{background:linear-gradient(135deg,#2c3e50,#34495e);border:2px solid #3498db;color:#fff}
    .discard{background:#fff;border:2px solid #e74c3c;color:#111}

    .action-bar{position:absolute;bottom:170px;left:50%;transform:translateX(-50%);display:flex;gap:14px;flex-wrap:wrap;z-index:5}
    .action-btn{padding:12px 18px;border:none;border-radius:12px;font-weight:900;cursor:pointer;transition:transform .1s ease}
    .action-btn:active{transform:translateY(1px)}
    .action-btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-discard{background:#b94a3e;color:#fff}
    .btn-draw-s{background:#2c7be5;color:#fff}
    .btn-draw-d{background:#b58900;color:#fff}
    .btn-lakdi{background:#239b56;color:#fff}

    .player-hand{position:absolute;bottom:24px;left:50%;transform:translateX(-50%);display:flex;gap:12px;z-index:5}
    .card{width:90px;height:120px;background:#fff;border-radius:12px;border:2px solid var(--card-b);
      display:flex;align-items:center;justify-content:center;color:#111;font-size:28px;font-weight:900;
      cursor:pointer;transition:transform .18s ease, box-shadow .18s ease}
    .card.red{color:#e74c3c}
    .card.selected{transform:translateY(-14px);box-shadow:0 12px 20px rgba(0,0,0,.25);border-color:#ffd700}

    /* Timer bottom-right */
    .turn-timer{position:fixed;right:18px;bottom:18px;width:44px;height:44px;border-radius:50%;
      border:3px solid rgba(255,215,0,.25);display:flex;align-items:center;justify-content:center;
      color:#ffd700;font-weight:800;font-size:14px;background:rgba(0,0,0,.35);z-index:20}
    .timer-circle{position:absolute;inset:-3px;border-radius:50%;border:3px solid transparent;
      border-top-color:#ffd700;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.78);display:flex;align-items:center;justify-content:center;z-index:40}
    .modal-content{background:linear-gradient(135deg,var(--bg1),var(--bg2));border:1px solid rgba(255,255,255,.3);
      border-radius:18px;padding:22px 20px;width:min(920px,92vw);max-height:82vh;overflow:auto}
    .hands-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:14px}
    .hand-display{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:12px}
    .hand-display.winner{border-color:#2ecc71;background:rgba(46,204,113,.22)}
    .hand-display.penalty{border-color:#e74c3c;background:rgba(231,76,60,.22)}
    .mini{width:50px;height:70px;background:#fff;border:2px solid var(--card-b);border-radius:8px;display:flex;
      align-items:center;justify-content:center;font-weight:900;margin:2px}
    .mini.red{color:#e74c3c}

    .host-start{position:absolute;top:20px;right:280px;background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.2);
      border-radius:12px;padding:10px 12px;z-index:6}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <div id="status" class="connection-status">ðŸŸ¢ Ready</div>

  <!-- Lobby -->
  <section id="lobby" class="login-wrap">
    <div class="login-card">
      <div class="brand"><div class="logo"></div><div class="title">Lakdi</div></div>
      <div class="field"><input id="nameInput" class="input" placeholder="Enter your name" maxlength="20"/></div>
      <div class="field"><input id="codeInput" class="input" placeholder="Room code (leave empty to create)" maxlength="6"/></div>
      <div class="stack">
        <button id="joinBtn" class="button btn-join">Join Multiplayer</button>
        <button id="createBtn" class="button btn-create">Create New Room</button>
        <button id="cpuBtn" class="button btn-cpu">ðŸ¤– Play vs Computer</button>
      </div>
      <div id="lobbyMsg" style="margin-top:10px;color:#8ab4ff;font-weight:700"></div>
    </div>
  </section>

  <!-- Game -->
  <section id="game" class="game-container hidden">
    <div class="scoreboard">
      <h3>Scores</h3>
      <div id="roomInfo" style="text-align:center;margin-bottom:6px;font-weight:800;color:#ffd700"></div>
      <div id="scores"></div>
    </div>
    <div id="hostStart" class="host-start hidden">
      <button id="btnStart" class="button" style="background:#2563eb;padding:10px 16px;border-radius:10px;font-weight:900">
        Start Game
      </button>
      <div id="startHint" style="font-size:12px;opacity:.85;margin-top:6px">Need at least 2 players</div>
    </div>
    <div class="game-table">
      <div id="seats" class="players-container"></div>
      <div class="table-center">
        <div id="stockPile" class="pile stock"><div>Stock</div><div id="stockCount">0</div></div>
        <div id="discardPile" class="pile discard"><div id="discardTop">Empty</div></div>
      </div>
      <div class="action-bar">
        <button id="btnDiscard" class="action-btn btn-discard" disabled>Discard</button>
        <button id="btnDrawS" class="action-btn btn-draw-s" disabled>Draw Stock</button>
        <button id="btnDrawD" class="action-btn btn-draw-d" disabled>Draw Discard</button>
        <button id="btnLakdi" class="action-btn btn-lakdi" disabled>Call Lakdi</button>
      </div>
      <div id="hand" class="player-hand"></div>
    </div>
  </section>

  <!-- Timer -->
  <div id="turnTimer" class="turn-timer hidden"><div class="timer-circle"></div><span id="tleft">30</span></div>

  <!-- Showdown -->
  <div id="showdown" class="modal hidden">
    <div class="modal-content">
      <h2>Round Results</h2>
      <div id="handsGrid" class="hands-grid"></div>
      <div style="text-align:center;margin-top:10px">
        <button id="closeShowdown" class="button btn-blue" style="background:#2563eb;width:auto;padding:10px 16px;border-radius:10px">Continue</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const suit = {hearts:"â™¥",diamonds:"â™¦",clubs:"â™£",spades:"â™ "};
const isRed = s => (s==="hearts"||s==="diamonds");
const val = r => r==="A"?1:r==="J"?11:r==="Q"?12:r==="K"?13:parseInt(r,10);
const sum = hand => hand.reduce((a,c)=>a+val(c.rank),0);
const label = c => `${c.rank}${suit[c.suit]}`;

/* ---------- Socket & State ---------- */
const socket = io("https://lakdi.onrender.com",{transports:["websocket","polling"]});
let me=null, room=null;
let selectedIdx=[];                // indices of my selected cards
let eligibleDiscardCard=null;      // frozen at start of my turn (prev player's top)
let timer=null, timeLeft=30;

/* ---------- Timer ---------- */
function startTimer(){
  clearInterval(timer); timeLeft=30;
  $("turnTimer").classList.remove("hidden");
  $("tleft").textContent=timeLeft;
  timer=setInterval(()=>{
    timeLeft--; $("tleft").textContent=timeLeft;
    if(timeLeft<=0){
      clearInterval(timer); $("turnTimer").classList.add("hidden");
      autoPlay();
    }
  },1000);
}
function stopTimer(){ clearInterval(timer); $("turnTimer").classList.add("hidden"); }

function autoPlay(){
  const mine=room.hands?.[me.id]||[];
  if(mine.length===3){
    // auto-discard highest single
    let hiIndex=0;
    for(let i=1;i<mine.length;i++) if(val(mine[i].rank)>val(mine[hiIndex].rank)) hiIndex=i;
    socket.emit("discard",{code:room.code,cards:[mine[hiIndex]]},()=>{ selectedIdx=[]; });
  }else if(mine.length===2){
    // auto-draw stock
    socket.emit("draw",{code:room.code,source:"stock"});
  }
}

/* ---------- Validation ---------- */
function validDiscard(){
  if(selectedIdx.length<1||selectedIdx.length>3) return false;
  const mine=room.hands?.[me.id]||[];
  const r0=mine[selectedIdx[0]].rank;
  return selectedIdx.every(ix=>mine[ix].rank===r0);
}

/* ---------- Buttons ---------- */
function updateButtons(){
  const myTurn=room.currentTurn===me.id;
  const myLen=(room.hands?.[me.id]||[]).length;
  const canDraw=myTurn && myLen===2; // draw only after discarding (3->2)
  $("btnDiscard").disabled=!(myTurn && validDiscard());
  $("btnDrawS").disabled=!canDraw;
  $("btnDrawD").disabled=!(canDraw && !!eligibleDiscardCard);
  $("btnLakdi").disabled=!(myTurn && !room.firstTurn && myLen===3);
}

/* ---------- Render ---------- */
function renderHand(){
  const wrap=$("hand"); wrap.innerHTML="";
  const mine=room.hands?.[me.id]||[];
  mine.forEach((c,i)=>{
    const div=document.createElement("div");
    div.className=`card ${isRed(c.suit)?'red':''} ${selectedIdx.includes(i)?'selected':''}`;
    div.textContent=label(c);
    div.onclick=()=>onCardClick(i);
    wrap.appendChild(div);
  });
}
function renderSeats(){
  const container=$("seats"); container.innerHTML="";
  const others=room.players.filter(p=>p.id!==me.id);
  const pos=["seat-top","seat-r1","seat-r2","seat-b1","seat-l1","seat-l2"];
  others.forEach((p,i)=>{
    const seat=document.createElement("div");
    seat.className=`player-seat ${pos[i%pos.length]} ${room.currentTurn===p.id?'active':''}`;
    const backs=(room.hands[p.id]||[]).length;
    seat.innerHTML=`
      <div class="player-info">
        <div class="player-name">${p.name}${p.isHost?' ðŸ‘‘':''}</div>
        <div class="player-score">${p.score||0} pts</div>
      </div>
      <div class="player-cards">${Array(backs).fill(0).map(()=>'<div class="card-back"></div>').join('')}</div>
    `;
    container.appendChild(seat);
  });
}
function renderScores(){
  const list=$("scores"); list.innerHTML="";
  const sorted=[...room.players].sort((a,b)=>(a.score||0)-(b.score||0));
  sorted.forEach((p,i)=>{
    const el=document.createElement("div");
    el.className=`score-item ${i===0?'winner':''}`;
    el.innerHTML=`<span>${p.name}${p.isHost?' ðŸ‘‘':''}</span><span>${p.score||0}</span>`;
    list.appendChild(el);
  });
}
function renderPiles(){
  $("stockCount").textContent=room.stockCount ?? (room.stock?.length||0);
  const top = room.discardTop || (room.discard?.at?.(-1)) || null;
  $("discardTop").textContent = top ? label(top) : "Empty";
}
function renderAll(){
  if(!room||!me) return;
  renderSeats();
  renderHand();
  renderScores();
  renderPiles();
  updateButtons();
  updateStartControls();
}

/* ---------- Selection ---------- */
function onCardClick(i){
  if(room.currentTurn!==me.id) return;
  const mine=room.hands?.[me.id]||[];
  if(selectedIdx.includes(i)){ selectedIdx=selectedIdx.filter(x=>x!==i); }
  else{
    if(selectedIdx.length){ const r0=mine[selectedIdx[0]].rank;
      if(mine[i].rank!==r0) selectedIdx=[]; }
    if(selectedIdx.length<3) selectedIdx.push(i);
  }
  renderHand(); updateButtons();
}

/* ---------- Actions ---------- */
$("btnDiscard").onclick=()=>{
  if(!validDiscard()) return;
  const mine=room.hands?.[me.id]||[];
  const cards=selectedIdx.map(ix=>mine[ix]);
  // Discard THEN draw (server enforces turn flow)
  socket.emit("discard",{code:room.code,cards},()=>{ selectedIdx=[]; updateButtons(); });
};
$("btnDrawS").onclick=()=> socket.emit("draw",{code:room.code,source:"stock"});
$("btnDrawD").onclick=()=>{
  if(!eligibleDiscardCard) return;
  socket.emit("draw",{code:room.code,source:"discard",take:eligibleDiscardCard});
};
$("btnLakdi").onclick=()=> socket.emit("call_lakdi",{code:room.code});

/* ---------- Lobby ---------- */
function showGame(code, hideCode=false){
  $("lobby").classList.add("hidden");
  $("game").classList.remove("hidden");
  $("roomInfo").textContent = hideCode ? '' : (code ? `Room: ${code}` : '');
}
$("createBtn").onclick=()=>{
  const name=$("nameInput").value.trim()||"Player";
  socket.emit("create_room",{name},res=>{
    if(res?.error){ $("lobbyMsg").textContent=res.error; return; }
    me=res.me; showGame(res.code);
  });
};
$("joinBtn").onclick=()=>{
  const name=$("nameInput").value.trim()||"Player";
  const code=($("codeInput").value||"").trim().toUpperCase();
  socket.emit("join_room",{name,code},res=>{
    if(res?.error){ $("lobbyMsg").textContent=res.error; return; }
    me=res.me; showGame(res.code);
  });
};
$("cpuBtn").onclick=async()=>{
  const name=$("nameInput").value.trim()||"Player";
  const difficulty=(prompt("Difficulty (easy / medium / hard)","easy")||"easy").toLowerCase();
  const bots=Math.min(5,Math.max(1,parseInt(prompt("How many bots? (1-5)","1")||"1",10)));
  socket.emit("single_player",{name,difficulty,bots},res=>{
    if(res?.error){ $("lobbyMsg").textContent=res.error; return; }
    me=res.me; showGame(null,true); // hide room code for CPU
  });
};

/* ---------- Host controls ---------- */
function isHostUser(){ if(!room||!me) return false; const mine=room.players?.find(p=>p.id===me.id); return !!(mine?.isHost||room.hostId===me.id); }
function inLobbyPhase(){ if(!room) return false; if(room.phase) return room.phase==='lobby'; if(room.gamePhase) return room.gamePhase==='lobby'; return !room.hands||Object.keys(room.hands).length===0; }
function updateStartControls(){
  const code=room?.code||room?.roomCode||'';
  // Keep whatever showGame decided: do not overwrite when CPU game
  if($("roomInfo").textContent.startsWith('Room:') || $("roomInfo").textContent===''){
    $("roomInfo").textContent = code ? `Room: ${code}` : $("roomInfo").textContent;
  }
  const panel=$("hostStart"); const btn=$("btnStart"); const hint=$("startHint");
  const show=isHostUser()&&inLobbyPhase();
  panel.classList.toggle('hidden', !show);
  if(!show) return;
  const n=(room.players||[]).length;
  btn.disabled = n<2;
  hint.textContent = n>=2 ? 'Ready to start' : 'Need at least 2 players';
}
$("btnStart").onclick=()=>{ const code=room?.code||room?.roomCode; if(!code) return; socket.emit("start_game",{code,endThreshold:200}); };

/* ---------- Socket events ---------- */
socket.on("connect",()=>{ $("status").textContent="ðŸŸ¢ Connected"; });
socket.on("connect_error",()=>{ $("status").textContent="ðŸ”´ Disconnected"; });

socket.on("room_state",st=>{
  const prev=room; room=st;
  if(!me) me=st.players.find(p=>p.id===socket.id)||me;

  // Freeze previous top-of-discard at the instant it becomes MY turn
  if(!prev || prev.currentTurn!==st.currentTurn){
    if(st.currentTurn===me?.id){
      eligibleDiscardCard = prev
        ? (prev.discardTop || (prev.discard?.at?.(-1)) || null)
        : (st.initialDiscard || null);
      startTimer();
    }else{
      stopTimer();
      eligibleDiscardCard = null; // never allow me to draw my own discard
    }
    selectedIdx=[];
  }
  renderAll();
});

/* ---------- Showdown (server-driven) ---------- */
socket.on("showdown_summary",msg=>{
  const grid=$("handsGrid"); grid.innerHTML="";
  const winner=msg.results.winner;
  room.players.forEach(p=>{
    const box=document.createElement("div");
    box.className="hand-display"+(p.id===winner?' winner':'')+(msg.results.penalties[p.id]===50?' penalty':'');

    const cards=(msg.hands[p.id]||[]).map(c=>
      `<div class="mini ${isRed(c.suit)?'red':''}">${label(c)}</div>`
    ).join('');

    const tot = (p.id===winner?0:sum(msg.hands[p.id]||[])) + (msg.results.penalties[p.id]===50?50:0);

    box.innerHTML = `
      <div class="player-name" style="font-weight:900">${p.name}</div>
      <div style="display:flex;flex-wrap:wrap">${cards}</div>
      <div>Total: ${tot}</div>
      ${p.id===winner?'<div style="color:#2ecc71;font-weight:900">Winner!</div>':''}
      ${msg.results.penalties[p.id]===50?'<div style="color:#e74c3c;font-weight:900">Penalty +50</div>':''}
    `;
    grid.appendChild(box);
  });
  $("showdown").classList.remove("hidden");
});
$("closeShowdown").onclick=()=>{ $("showdown").classList.add("hidden"); socket.emit("next_round",{code:room.code}); };

/* ---------- Initial focus ---------- */
document.addEventListener('DOMContentLoaded',()=> $("nameInput").focus());
</script>
</body>
</html>
