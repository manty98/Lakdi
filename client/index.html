<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lakdi - Multiplayer Card Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root{
      --bg1:#1a4f3a; --bg2:#0d2818; --gold:#ffd700; --panel:rgba(255,255,255,.08);
      --panel-b:rgba(255,255,255,.15); --muted:rgba(255,255,255,.6);
      --btn-red:#ee5a24; --btn-blue:#4f46e5; --btn-green:#2ecc71;
      --card-b:#cbd5e1; --card-shadow:0 12px 24px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;overflow:hidden}

    /* Status pill */
    .connection-status{position:fixed;top:16px;left:16px;padding:10px 14px;border-radius:12px;background:rgba(46,204,113,.16);border:1px solid #2ecc71;color:#2ecc71;font-weight:700;z-index:50}

    /* ---------- LOBBY (as in your screenshot) ---------- */
    .login-wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
    .login-card{width:min(560px,92vw);background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:22px;padding:32px 28px;box-shadow:var(--card-shadow)}
    .brand{display:flex;justify-content:center;align-items:center;gap:14px;margin-bottom:22px}
    .brand .logo{width:46px;height:46px;border-radius:10px;background:var(--gold)}
    .brand .title{font-size:48px;font-weight:900;color:var(--gold)}
    .field{margin:12px 0}
    .input{width:100%;padding:14px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.28);background:rgba(255,255,255,.08);color:#fff;font-size:16px;outline:none}
    .input::placeholder{color:var(--muted)}
    .button{width:100%;padding:16px 18px;border:none;border-radius:14px;color:#fff;font-weight:900;letter-spacing:.2px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 8px 18px rgba(0,0,0,.2);transition:transform .1s ease}
    .button:active{transform:translateY(1px)}
    .btn-join{background:linear-gradient(45deg,#ff6b6b,var(--btn-red))}
    .btn-create{background:linear-gradient(45deg,#4834d4,var(--btn-blue))}
    .btn-cpu{background:linear-gradient(45deg,#27ae60,var(--btn-green))}
    .stack{display:grid;gap:14px;margin-top:10px}

    /* ---------- GAME TABLE (your layout) ---------- */
    .game-container{height:100%;display:flex;flex-direction:column;position:relative}
    .scoreboard{position:absolute;top:20px;right:20px;background:rgba(0,0,0,.85);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:18px 16px;min-width:220px;z-index:5}
    .scoreboard h3{margin:0 0 10px;color:var(--gold);text-align:center}
    .score-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:8px;margin:6px 0;background:rgba(255,255,255,.06)}
    .score-item.winner{background:rgba(46,204,113,.28)}
    .game-table{flex:1;display:flex;align-items:center;justify-content:center;position:relative;padding:22px}
    .players-container{position:absolute;inset:0}
    .player-seat{position:absolute;display:flex;flex-direction:column;align-items:center;gap:10px;min-width:120px}
    .player-seat.active{animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.75}}
    .player-info{background:var(--panel);border:1px solid var(--panel-b);border-radius:14px;padding:10px 14px;text-align:center}
    .player-name{font-weight:800;margin-bottom:4px}
    .player-score{font-size:14px;color:var(--gold)}
    .player-cards{display:flex;gap:6px}
    .card-back{width:30px;height:42px;border-radius:6px;background:linear-gradient(135deg,#2c3e50,#34495e);border:1px solid #3498db}
    /* seats around */
    .seat-top{top:8%;left:50%;transform:translateX(-50%)}
    .seat-r1{top:20%;right:10%}
    .seat-r2{top:50%;right:5%;transform:translateY(-50%)}
    .seat-b1{bottom:20%;right:10%}
    .seat-l1{bottom:20%;left:10%}
    .seat-l2{top:50%;left:5%;transform:translateY(-50%)}

    .table-center{position:relative;display:flex;align-items:center;justify-content:center;gap:20px}
    .pile{width:90px;height:120px;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:transform .12s ease;font-weight:700}
    .pile:hover{transform:scale(1.05)}
    .stock{background:linear-gradient(135deg,#2c3e50,#34495e);border:2px solid #3498db;color:#fff}
    .discard{background:#fff;border:2px solid #e74c3c;color:#111}
    .badge{position:absolute;top:-12px;right:-12px;background:rgba(255,215,0,.18);border:2px solid #ffd700;color:#ffd700;border-radius:999px;padding:6px 8px;font-weight:900}

    /* your action bar */
    .action-bar{position:absolute;bottom:170px;left:50%;transform:translateX(-50%);display:flex;gap:14px;flex-wrap:wrap;z-index:5}
    .action-btn{padding:12px 18px;border:none;border-radius:12px;font-weight:900;cursor:pointer;transition:transform .1s ease}
    .action-btn:active{transform:translateY(1px)}
    .action-btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-discard{background:#b94a3e;color:#fff}
    .btn-draw-s{background:#2c7be5;color:#fff}
    .btn-draw-d{background:#b58900;color:#fff}
    .btn-lakdi{background:#239b56;color:#fff}

    .player-hand{position:absolute;bottom:24px;left:50%;transform:translateX(-50%);display:flex;gap:12px;z-index:5}
    .card{width:90px;height:120px;background:#fff;border-radius:12px;border:2px solid var(--card-b);display:flex;align-items:center;justify-content:center;color:#111;font-size:28px;font-weight:900;cursor:pointer;transition:transform .18s ease, box-shadow .18s ease}
    .card.red{color:#e74c3c}
    .card.selected{transform:translateY(-14px);box-shadow:0 12px 20px rgba(0,0,0,.25);border-color:#ffd700}

    /* timer */
    .turn-timer{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:60px;height:60px;border-radius:50%;border:4px solid rgba(255,215,0,.28);display:flex;align-items:center;justify-content:center;color:#ffd700;font-weight:900}
    .timer-circle{position:absolute;inset:-4px;border-radius:50%;border:4px solid transparent;border-top-color:#ffd700;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.78);display:flex;align-items:center;justify-content:center;z-index:40}
    .modal-content{background:linear-gradient(135deg,var(--bg1),var(--bg2));border:1px solid rgba(255,255,255,.3);border-radius:18px;padding:22px 20px;width:min(920px,92vw);max-height:82vh;overflow:auto}
    .hands-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:14px}
    .hand-display{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:12px}
    .hand-display.winner{border-color:#2ecc71;background:rgba(46,204,113,.22)}
    .hand-display.penalty{border-color:#e74c3c;background:rgba(231,76,60,.22)}
    .mini{width:50px;height:70px;background:#fff;border:2px solid var(--card-b);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:900;margin:2px}
    .mini.red{color:#e74c3c}
    .hidden{display:none!important}

    @media (max-width:768px){
      .player-hand .card{width:74px;height:98px}
      .action-bar{bottom:144px}
      .scoreboard{min-width:180px;padding:14px}
      .pile{width:80px;height:108px}
    }
  </style>
</head>
<body>
  <div id="status" class="connection-status">ðŸŸ¢ Ready</div>

  <!-- LOBBY (screenshot) -->
  <section id="lobby" class="login-wrap">
    <div class="login-card">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">Lakdi</div>
      </div>
      <div class="field"><input id="nameInput" class="input" placeholder="Enter your name" maxlength="20"/></div>
      <div class="field"><input id="codeInput" class="input" placeholder="Room code (leave empty to create)" maxlength="6"/></div>
      <div class="stack">
        <button id="joinBtn" class="button btn-join">Join Multiplayer</button>
        <button id="createBtn" class="button btn-create">Create New Room</button>
        <button id="cpuBtn" class="button btn-cpu">ðŸ¤– Play vs Computer</button>
      </div>
      <div id="lobbyMsg" style="margin-top:10px;color:#8ab4ff;font-weight:700"></div>
    </div>
  </section>

  <!-- GAME -->
  <section id="game" class="game-container hidden">
    <div class="scoreboard">
      <h3>Scores</h3>
      <div id="scores"></div>
    </div>

    <div class="game-table">
      <div id="seats" class="players-container"></div>

      <div class="table-center">
        <div id="stockPile" class="pile stock"><div>Stock</div><div id="stockCount">0</div></div>
        <div id="discardPile" class="pile discard"><div id="discardTop">Empty</div></div>
        <div id="turnTimer" class="turn-timer hidden"><div class="timer-circle"></div><span id="tleft">30</span></div>
      </div>

      <div class="action-bar">
        <button id="btnDiscard" class="action-btn btn-discard" disabled>Discard</button>
        <button id="btnDrawS" class="action-btn btn-draw-s" disabled>Draw Stock</button>
        <button id="btnDrawD" class="action-btn btn-draw-d" disabled>Draw Discard</button>
        <button id="btnLakdi" class="action-btn btn-lakdi" disabled title="Available after 1st turn">Call Lakdi</button>
      </div>

      <div id="hand" class="player-hand"></div>
    </div>
  </section>

  <!-- SHOWDOWN -->
  <div id="showdown" class="modal hidden">
    <div class="modal-content">
      <h2>Round Results</h2>
      <div id="handsGrid" class="hands-grid"></div>
      <div style="text-align:center;margin-top:10px">
        <button id="closeShowdown" class="button btn-blue" style="background:#2563eb;width:auto;padding:10px 16px;border-radius:10px">Continue</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------------- Helpers (UI) ---------------- */
    const $ = id => document.getElementById(id);
    const suit = {hearts:"â™¥",diamonds:"â™¦",clubs:"â™£",spades:"â™ "};
    const isRed = s => (s==="hearts"||s==="diamonds");
    const val = r => r==="A"?1:r==="J"?11:r==="Q"?12:r==="K"?13:parseInt(r,10);
    const sum = hand => hand.reduce((a,c)=>a+val(c.rank),0);
    const label = c => `${c.rank}${suit[c.suit]}`;

    /* ---------------- State ---------------- */
    const socket = io("https://lakdi.onrender.com", { transports: ["websocket","polling"] });
    let me=null, room=null;
    let selectedIdx=[];              // selected indices in my hand (for discard)
    let eligibleDiscardTop=null;     // the previous top-of-discard you may take this turn
    let timer=null, timeLeft=30;

    /* ---------------- Lobby actions ---------------- */
    function showGame(){ $("lobby").classList.add("hidden"); $("game").classList.remove("hidden"); }
    function showLobby(){ $("lobby").classList.remove("hidden"); $("game").classList.add("hidden"); }

    $("createBtn").onclick = () => {
      const name = $("nameInput").value.trim()||"Player";
      socket.emit("create_room",{name},res=>{
        if(res?.error){ $("lobbyMsg").textContent=res.error; return; }
        me=res.me; $("lobbyMsg").textContent=`Room: ${res.code}`;
        showGame();
      });
    };
    $("joinBtn").onclick = () => {
      const name = $("nameInput").value.trim()||"Player";
      const code = ($("codeInput").value||"").trim().toUpperCase();
      socket.emit("join_room",{name,code},res=>{
        if(res?.error){ $("lobbyMsg").textContent=res.error; return; }
        me=res.me; $("lobbyMsg").textContent=`Joined: ${res.code}`;
        showGame();
      });
    };
    $("cpuBtn").onclick = () => {
      // Single-player session on server
      const name = $("nameInput").value.trim()||"Player";
      socket.emit("single_player",{name},res=>{
        if(res?.error){ $("lobbyMsg").textContent=res.error; return; }
        me=res.me; $("lobbyMsg").textContent="Single-player vs bots";
        showGame();
      });
    };

    /* ---------------- Rendering ---------------- */
    function renderAll(){
      if(!room||!me) return;
      renderSeats();
      renderHand();
      renderScores();
      renderPiles();
      updateButtons();
    }
    function renderSeats(){
      const seats=$("seats"); seats.innerHTML="";
      const others = room.players.filter(p=>p.id!==me.id);
      const classes = ["seat-top","seat-r1","seat-r2","seat-b1","seat-l1","seat-l2"];
      others.forEach((p,i)=>{
        const seat=document.createElement("div");
        seat.className=`player-seat ${classes[i%classes.length]} ${room.currentTurn===p.id?'active':''}`;
        const backs = (room.hands[p.id]||[]).length;
        seat.innerHTML = `
          <div class="player-info">
            <div class="player-name">${p.name}${p.isHost?' ðŸ‘‘':''}</div>
            <div class="player-score">${p.score||0} pts</div>
          </div>
          <div class="player-cards">${Array(backs).fill(0).map(()=>'<div class="card-back"></div>').join('')}</div>
        `;
        seats.appendChild(seat);
      });
    }
    function renderHand(){
      const wrap=$("hand"); wrap.innerHTML="";
      const mine = room.hands?.[me.id]||[];
      mine.forEach((c,i)=>{
        const div=document.createElement("div");
        div.className=`card ${isRed(c.suit)?'red':''} ${selectedIdx.includes(i)?'selected':''}`;
        div.textContent = label(c);
        div.onclick = () => onCardClick(i);
        wrap.appendChild(div);
      });
    }
    function renderScores(){
      const list=$("scores"); list.innerHTML="";
      const sorted=[...room.players].sort((a,b)=>(a.score||0)-(b.score||0));
      sorted.forEach((p,i)=>{
        const el=document.createElement("div");
        el.className=`score-item ${i===0?'winner':''}`;
        el.innerHTML=`<span>${p.name}${p.isHost?' ðŸ‘‘':''}</span><span>${p.score||0}</span>`;
        list.appendChild(el);
      });
    }
    function renderPiles(){
      $("stockCount").textContent = room.stockCount ?? (room.stock?.length||0);
      const top = room.discardTop || (room.discard?.at(-1)) || null;
      $("discardTop").textContent = top ? label(top) : "Empty";
    }

    /* ---------------- Selection & validation ---------------- */
    function onCardClick(i){
      if(room.currentTurn!==me.id) return;
      const mine = room.hands?.[me.id]||[];
      const already = selectedIdx.includes(i);
      if(already){ selectedIdx = selectedIdx.filter(x=>x!==i); }
      else{
        if(selectedIdx.length){
          const r0 = mine[selectedIdx[0]].rank;
          if(mine[i].rank!==r0) selectedIdx=[]; // enforce same rank
        }
        if(selectedIdx.length<3) selectedIdx.push(i);
      }
      renderHand(); updateButtons();
    }
    function validDiscard(){
      if(selectedIdx.length<1 || selectedIdx.length>3) return false;
      if(selectedIdx.length===1) return true;
      const mine = room.hands?.[me.id]||[];
      const r0 = mine[selectedIdx[0]].rank;
      return selectedIdx.every(ix => mine[ix].rank===r0);
    }

    /* ---------------- Buttons enablement ---------------- */
    function updateButtons(){
      const myTurn = room.currentTurn===me.id;
      const myLen = (room.hands?.[me.id]||[]).length;
      // FIX 1: allow draw after discarding 1/2/3 => enable draw if hand has <=2 and it's your turn
      const canDraw = myTurn && myLen <= 2;

      $("btnDiscard").disabled = !(myTurn && validDiscard());
      $("btnDrawS").disabled = !canDraw;
      // FIX 2: can only take previous top-of-discard (snapshotted at turn start)
      $("btnDrawD").disabled = !(canDraw && eligibleDiscardTop);
      $("btnLakdi").disabled = !(myTurn && !room.firstTurn && myLen===3);
    }

    /* ---------------- Timer (resets each turn/round) ---------------- */
    function startTimer(){
      clearInterval(timer); timeLeft=30;
      $("turnTimer").classList.remove("hidden");
      $("tleft").textContent=timeLeft;
      timer=setInterval(()=>{
        timeLeft--; $("tleft").textContent=timeLeft;
        if(timeLeft<=0){
          clearInterval(timer); $("turnTimer").classList.add("hidden");
          // auto: ask server to auto-move
          socket.emit("auto_play",{code:room.code});
        }
      },1000);
    }
    function stopTimer(){ clearInterval(timer); $("turnTimer").classList.add("hidden"); }

    /* ---------------- Actions -> server ---------------- */
    $("btnDiscard").onclick = () => {
      if(!validDiscard()) return;
      const mine = room.hands?.[me.id]||[];
      const cards = selectedIdx.map(ix=>mine[ix]);
      socket.emit("discard",{code:room.code,cards},() => { selectedIdx=[]; });
    };
    $("btnDrawS").onclick = () => socket.emit("draw",{code:room.code,source:"stock"});
    $("btnDrawD").onclick = () => socket.emit("draw",{code:room.code,source:"discard"});
    $("btnLakdi").onclick = () => socket.emit("call_lakdi",{code:room.code});

    // Pile click shortcuts
    $("stockPile").onclick = () => { if(!$("btnDrawS").disabled) $("btnDrawS").click(); };
    $("discardPile").onclick = () => { if(!$("btnDrawD").disabled) $("btnDrawD").click(); };

    /* ---------------- Socket events ---------------- */
    socket.on("connect",()=>{ $("status").textContent="ðŸŸ¢ Connected"; });
    socket.on("connect_error",e=>{ $("status").textContent="ðŸ”´ Disconnected"; });

    // Main room state from server
    socket.on("room_state",st=>{
      const prev = room;
      room = st;
      if(!me) me = st.players.find(p=>p.id===socket.id);

      // snapshot previous top-of-discard at the beginning of MY TURN
      if(!prev || prev.currentTurn!==st.currentTurn){
        if(st.currentTurn===me?.id){
          eligibleDiscardTop = st.discardPrevTop || st.discardTop || (st.discard?.at(-1)) || null;
          startTimer();
        }else{
          stopTimer();
        }
        // reset selection on turn change
        selectedIdx=[];
      }

      renderAll();
    });

    // Showdown summary -> open modal and display hands/totals
    socket.on("showdown_summary",(msg)=>{
      // msg: {hands: {pid:[cards]}, results:{winner, penalties{}}}
      const grid=$("handsGrid"); grid.innerHTML="";
      const winner = msg.results.winner;

      room.players.forEach(p=>{
        const box=document.createElement("div");
        box.className="hand-display"+(p.id===winner?' winner':'')+(msg.results.penalties[p.id]===50?' penalty':'');
        const cards=(msg.hands[p.id]||[]).map(c=>`<div class="mini ${isRed(c.suit)?'red':''}">${label(c)}</div>`).join('');
        const tot = (p.id===winner?0:sum(msg.hands[p.id]||[])) + (msg.results.penalties[p.id]===50?50:0);
        box.innerHTML = `
          <div class="player-name" style="font-weight:900">${p.name}</div>
          <div style="display:flex;flex-wrap:wrap">${cards}</div>
          <div>Total: ${tot}</div>
          ${p.id===winner?'<div style="color:#2ecc71;font-weight:900">Winner!</div>':''}
          ${msg.results.penalties[p.id]===50?'<div style="color:#e74c3c;font-weight:900">Penalty +50</div>':''}
        `;
        grid.appendChild(box);
      });

      $("showdown").classList.remove("hidden");
    });

    $("closeShowdown").onclick = ()=> {
      $("showdown").classList.add("hidden");
      // ask server to start next round (server enforces endThreshold)
      socket.emit("next_round",{code:room.code});
    };

    /* -------------- Keyboard helpers -------------- */
    document.addEventListener('keydown',e=>{
      if($("game").classList.contains("hidden")) return;
      if(e.key==='d'||e.key==='D'){ if(!$("btnDiscard").disabled) $("btnDiscard").click(); }
      if(e.key==='s'||e.key==='S'){ if(!$("btnDrawS").disabled) $("btnDrawS").click(); }
      if(e.key==='f'||e.key==='F'){ if(!$("btnDrawD").disabled) $("btnDrawD").click(); }
      if(e.key==='l'||e.key==='L'){ if(!$("btnLakdi").disabled) $("btnLakdi").click(); }
    });

    /* -------------- Initial focus -------------- */
    document.addEventListener('DOMContentLoaded',()=> $("nameInput").focus());
  </script>
</body>
</html>
