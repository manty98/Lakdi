<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lakdi – Multiplayer Card Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    fieldset { margin-bottom: 16px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 12px; cursor: pointer; }
    .card { border:1px solid #ccc; border-radius:6px; padding:6px 10px; margin:2px;
            display:inline-block; cursor:pointer; }
    .card.selected { border-color:#007aff; box-shadow:0 0 0 2px #007aff44; }
    .hand, .pile { display:flex; flex-wrap:wrap; gap:4px; margin-top:6px; }
    #log { white-space: pre-wrap; border:1px solid #ddd; padding:8px; margin-top:10px; height:120px; overflow:auto; }
    #err { color:#b00020; }
  </style>
</head>
<body>
  <h1>🎴 Lakdi – Multiplayer Card Game</h1>

  <fieldset>
    <legend>Lobby</legend>
    <div class="row">
      <label>Room</label><input id="room" value="demo" />
      <label>Name</label><input id="name" value="Player" />
      <button id="joinBtn">Join</button>
      <button id="addBotBtn">+Bot</button>
      <button id="startBtn">Start (host)</button>
    </div>
    <div id="err"></div>
  </fieldset>

  <fieldset>
    <legend>Game</legend>
    <div>Active turn: <span id="turnName">—</span></div>
    <div>Stock count: <span id="stockCount">0</span></div>
    <div>Declared: <span id="declared">false</span></div>

    <h4>Past Discard</h4>
    <div id="past" class="pile"></div>

    <h4>Immediate Discard</h4>
    <div id="immediate" class="pile"></div>
  </fieldset>

  <fieldset>
    <legend>Your Hand</legend>
    <div id="hand" class="hand"></div>
    <div class="row" style="margin-top:8px;">
      <button id="discardBtn">Discard (1–3 same rank)</button>
      <button id="drawStockBtn">Draw Stock</button>
      <button id="drawPastBtn">Draw Past</button>
      <button id="lakdiBtn">Call Lakdi</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Players</legend>
    <ul id="players"></ul>
  </fieldset>

  <h3>Log</h3>
  <div id="log"></div>

  <!-- Socket.IO client served by server.js -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const log = (...a) => { $("log").textContent += a.join(" ") + "\\n"; $("log").scrollTop = $("log").scrollHeight; };
    const isRed = (s) => s==="♥"||s==="♦";

    let socket, ROOM, STATE, SELECTED = new Set();

    function connect() {
      if (socket) return;
      socket = io();

      socket.on("connect", ()=>log("connected", socket.id));
      socket.on("joined", (info)=>log("joined room", info.roomId, info.host?"(host)":""));
      socket.on("error", (e)=>{ $("err").textContent = String(e); });
      socket.on("state", ({state})=>{
        STATE=state;
        renderAll();
      });
    }

    $("joinBtn").onclick = () => {
      connect();
      ROOM = ($("room").value||"demo").trim();
      const name = ($("name").value||"Player").trim();
      socket.emit("join", { roomId: ROOM, name });
    };
    $("addBotBtn").onclick = () => {
      if (!ROOM) return;
      socket.emit("addBot", { roomId: ROOM, difficulty:"easy" });
    };
    $("startBtn").onclick = () => {
      if (!ROOM) return;
      socket.emit("start", { roomId: ROOM, handSize:5 });
    };

    $("discardBtn").onclick = () => {
      if (!STATE?.you?.hand) return;
      const arr = Array.from(SELECTED).sort((a,b)=>a-b);
      if (!arr.length) return;
      socket.emit("discard",{ roomId:ROOM, handIndices:arr });
      SELECTED.clear();
    };
    $("drawStockBtn").onclick = ()=>socket.emit("draw",{ roomId:ROOM, source:"stock" });
    $("drawPastBtn").onclick = ()=>socket.emit("draw",{ roomId:ROOM, source:"past" });
    $("lakdiBtn").onclick = ()=>socket.emit("lakdi",{ roomId:ROOM });

    function renderAll(){
      $("err").textContent="";
      $("stockCount").textContent = STATE.stockCount;
      $("declared").textContent = STATE.declared;
      $("turnName").textContent = nameOf(STATE.activePlayerId);
      renderPlayers();
      renderHand();
      renderPile("past", STATE.pastDiscard||[]);
      renderPile("immediate", STATE.immediateDiscard||[]);
    }
    function renderPlayers(){
      $("players").innerHTML="";
      (STATE.players||[]).forEach(p=>{
        const li=document.createElement("li");
        li.textContent=`${p.name} (${p.handCount})${p.id===STATE.activePlayerId?" ← turn":""}`;
        $("players").appendChild(li);
      });
    }
    function renderHand(){
      const wrap=$("hand"); wrap.innerHTML="";
      (STATE.you?.hand||[]).forEach((c,i)=>{
        const d=document.createElement("div");
        d.className="card"+(SELECTED.has(i)?" selected":"");
        d.textContent=`${c.r}${c.s}`;
        if (isRed(c.s)) d.style.color="#e74c3c";
        d.onclick=()=>{ if(SELECTED.has(i))SELECTED.delete(i); else SELECTED.add(i); renderHand(); };
        wrap.appendChild(d);
      });
    }
    function renderPile(id,cards){
      const el=$(id); el.innerHTML="";
      cards.forEach(c=>{
        const d=document.createElement("div");
        d.className="card";
        d.textContent=`${c.r}${c.s}`;
        if (isRed(c.s)) d.style.color="#e74c3c";
        el.appendChild(d);
      });
    }
    function nameOf(id){
      const p=(STATE.players||[]).find(x=>x.id===id);
      return p?p.name:"—";
    }
  </script>
</body>
</html>
