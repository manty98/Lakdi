<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lakdi - Multiplayer Card Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a4f3a 0%, #0d2818 100%);
      color: white; height: 100vh; overflow: hidden;
    }
    .game-container { height: 100vh; display:flex; flex-direction:column; position:relative; }

    /* Login */
    .login-screen { display:flex; align-items:center; justify-content:center; height:100vh; background: linear-gradient(135deg, #1a4f3a 0%, #0d2818 100%); }
    .login-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; text-align:center; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.3); max-width: 400px; width: 90%; }
    .login-card h1 { font-size: 3em; margin-bottom: 30px; background: linear-gradient(45deg, #ffd700, #ffed4e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .login-form { display:flex; flex-direction:column; gap:20px; }
    .login-form input { padding:15px; border:none; border-radius:10px; background: rgba(255,255,255,0.1); color:#fff; font-size:16px; border:1px solid rgba(255,255,255,0.3); }
    .login-form input::placeholder { color: rgba(255,255,255,0.6); }
    .btn { padding: 15px 30px; border:none; border-radius:10px; font-size:16px; cursor:pointer; transition: all .3s ease; font-weight:600; }
    .btn-primary { background: linear-gradient(45deg, #ff6b6b, #ee5a24); color:#fff; }
    .btn-secondary { background: linear-gradient(45deg, #4834d4, #686de0); color:#fff; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,.2); }
    .btn:disabled { opacity:.5; cursor:not-allowed; transform:none; }
    .room-info { margin:20px 0; padding:15px; background: rgba(255,255,255,0.05); border-radius:10px; border:1px solid rgba(255,255,255,0.1); }
    .room-code { font-size:24px; font-weight:bold; color:#ffd700; margin:10px 0; letter-spacing:3px; }
    .status-message { color:#3498db; margin:10px 0; }
    .error-message { color:#e74c3c; margin:10px 0; }

    .connection-status { position:absolute; top:20px; left:20px; padding:10px 15px; border-radius:10px; font-size:14px; font-weight:600; }
    .connection-status.connected { background: rgba(46,204,113,.2); border:1px solid #2ecc71; color:#2ecc71; }
    .connection-status.disconnected { background: rgba(231,76,60,.2); border:1px solid #e74c3c; color:#e74c3c; }
    .connection-status.connecting { background: rgba(241,196,15,.2); border:1px solid #f1c40f; color:#f1c40f; }

    /* Lobby */
    .lobby-screen { display:flex; flex-direction:column; height:100vh; padding:20px; }
    .lobby-header { text-align:center; margin-bottom:30px; }
    .players-lobby { flex:1; display:flex; flex-direction:column; gap:20px; max-width:600px; margin:0 auto; }
    .player-list { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius:15px; padding:20px; border:1px solid rgba(255,255,255,0.2); }
    .player-item { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1); }
    .player-item:last-child { border-bottom:none; }
    .host-controls { display:flex; gap:15px; justify-content:center; flex-wrap:wrap; }

    /* Table */
    .game-table { flex:1; display:flex; align-items:center; justify-content:center; position:relative; padding:20px; }
    .table-center { position:relative; width:200px; height:200px; display:flex; align-items:center; justify-content:center; gap:20px; }
    .card-pile { width:80px; height:110px; border-radius:8px; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; cursor:pointer; transition:all .3s ease; font-size:12px; }
    .stock-pile { background: linear-gradient(135deg, #2c3e50, #34495e); border:2px solid #3498db; }
    .discard-pile { background:#fff; color:#000; border:2px solid #e74c3c; font-weight:bold; }
    .card-pile:hover { transform: scale(1.05); }

    .players-container { position:absolute; inset:0; }
    .player-seat { position:absolute; display:flex; flex-direction:column; align-items:center; gap:10px; min-width:120px; }
    .player-seat.active { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }
    .player-info { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding:10px 15px; border-radius:15px; text-align:center; border:1px solid rgba(255,255,255,0.2); }
    .player-name { font-weight:bold; margin-bottom:5px; }
    .player-score { font-size:14px; color:#ffd700; }
    .player-cards { display:flex; gap:-20px; }
    .card-back { width:30px; height:42px; background: linear-gradient(135deg, #2c3e50,#34495e); border-radius:4px; border:1px solid #3498db; }

    /* Positions */
    .player-seat:nth-child(1){ top:10%; left:50%; transform:translateX(-50%); }
    .player-seat:nth-child(2){ top:20%; right:10%; }
    .player-seat:nth-child(3){ top:50%; right:5%; transform:translateY(-50%); }
    .player-seat:nth-child(4){ bottom:20%; right:10%; }
    .player-seat:nth-child(5){ bottom:20%; left:10%; }
    .player-seat:nth-child(6){ top:50%; left:5%; transform:translateY(-50%); }

    /* Hand */
    .player-hand { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); display:flex; gap:10px; z-index:100; }
    .card { width:80px; height:110px; background:#fff; border-radius:8px; border:2px solid #ccc; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: all .3s ease; color:#000; font-weight:bold; font-size:20px; position:relative; }
    .card.selected { transform: translateY(-20px); border-color:#ffd700; box-shadow:0 10px 20px rgba(255,215,0,.3); }
    .card.red{ color:#e74c3c } .card.black{ color:#2c3e50 }
    .card:hover{ transform: translateY(-10px); }

    /* Actions */
    .action-bar { position:absolute; bottom:160px; left:50%; transform:translateX(-50%); display:flex; gap:15px; z-index:100; flex-wrap:wrap; justify-content:center; }
    .action-btn { padding:12px 20px; border:none; border-radius:10px; font-size:14px; cursor:pointer; transition:all .3s ease; font-weight:600; }
    .action-btn:disabled { opacity:.5; cursor:not-allowed; }
    .action-btn.discard{ background:#e74c3c; color:#fff; }
    .action-btn.draw-stock{ background:#3498db; color:#fff; }
    .action-btn.draw-discard{ background:#f39c12; color:#fff; }
    .action-btn.lakdi{ background:#2ecc71; color:#fff; }

    /* Scoreboard */
    .scoreboard { position:absolute; top:20px; right:20px; background:rgba(0,0,0,.8); backdrop-filter: blur(10px); border-radius:15px; padding:20px; min-width:200px; border:1px solid rgba(255,255,255,.2); }
    .scoreboard h3 { margin-bottom:15px; color:#ffd700; text-align:center; }
    .score-item { display:flex; justify-content:space-between; margin-bottom:8px; padding:5px 10px; border-radius:5px; transition:all .3s ease; }
    .score-item.winner { background: rgba(46,204,113,.3); }

    /* Modals */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.8); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .modal-content { background: linear-gradient(135deg, #1a4f3a,#0d2818); border-radius:20px; padding:30px; max-width:500px; width:90%; text-align:center; border:1px solid rgba(255,255,255,.3); max-height:80vh; overflow:auto; }
    .hands-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin:20px 0; }
    .hand-display { background: rgba(255,255,255,.1); padding:15px; border-radius:10px; border:1px solid rgba(255,255,255,.2); }
    .hand-display.winner { border-color:#2ecc71; background: rgba(46,204,113,.2); }
    .hand-display.penalty { border-color:#e74c3c; background: rgba(231,76,60,.2); }
    .hand-cards { display:flex; justify-content:center; gap:5px; margin:10px 0; }
    .mini-card { width:40px; height:55px; background:#fff; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:14px; color:#000; font-weight:bold; }
    .mini-card.red{ color:#e74c3c }

    /* Timer */
    .turn-timer { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:60px; height:60px; border-radius:50%; border:4px solid rgba(255,215,0,.3); display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:bold; color:#ffd700; }
    .timer-circle { position:absolute; top:-4px; left:-4px; width:60px; height:60px; border-radius:50%; border:4px solid transparent; border-top-color:#ffd700; animation: spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    @media (max-width: 768px) {
      .login-card{ padding:30px 20px; }
      .player-seat{ min-width:80px; }
      .player-seat:nth-child(n+5){ display:none; }
      .card{ width:60px; height:85px; font-size:16px; }
      .action-btn{ padding:10px 15px; font-size:12px; }
      .scoreboard{ top:10px; right:10px; padding:15px; min-width:150px; }
      .action-bar{ bottom:140px; }
    }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div id="connectionStatus" class="connection-status connected">üü¢ Ready</div>

  <!-- LOGIN -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h1>üÉè Lakdi</h1>
      <div class="login-form">
        <input id="playerName" placeholder="Enter your name" maxlength="20"/>
        <input id="roomCode" placeholder="Room code (leave empty to create)" maxlength="6"/>
        <button class="btn btn-primary" id="joinButton">Join Multiplayer</button>
        <button class="btn btn-secondary" id="createButton">Create New Room</button>
        <button class="btn btn-secondary" id="singleButton" style="background:linear-gradient(45deg,#2ecc71,#27ae60)">ü§ñ Play vs Computer</button>
        <div id="loginMessage" class="status-message"></div>
      </div>
    </div>
  </div>

  <!-- LOBBY -->
  <div id="lobbyScreen" class="lobby-screen hidden">
    <div class="lobby-header">
      <h1>üÉè Lakdi Game Lobby</h1>
      <div class="room-info">
        <div>Room Code:</div>
        <div class="room-code" id="displayRoomCode"></div>
        <div id="lobbyMessage" class="status-message">Waiting for players...</div>
      </div>
    </div>

    <div class="players-lobby">
      <div class="player-list">
        <h3>Players (<span id="playerCount">0</span>/18)</h3>
        <div id="playersList"></div>
      </div>

      <div class="host-controls" id="hostControls">
        <label> End Score:
          <select id="endThreshold">
            <option value="200">200 points</option>
            <option value="300">300 points</option>
          </select>
        </label>
        <button class="btn btn-primary" id="startGameBtn" disabled>Start Game (Need 2+ players)</button>
      </div>
    </div>
  </div>

  <!-- GAME -->
  <div id="gameScreen" class="game-container hidden">
    <div class="scoreboard">
      <h3>Scores</h3>
      <div id="scoresList"></div>
    </div>

    <div class="game-table">
      <div class="players-container" id="playersContainer"></div>

      <div class="table-center">
        <div class="card-pile stock-pile" id="stockPile"><div>Stock</div><div id="stockCount">0</div></div>
        <div class="card-pile discard-pile" id="discardPile"><div id="discardCard">Empty</div></div>
      </div>

      <div id="turnTimer" class="turn-timer hidden"><div class="timer-circle"></div><span id="timerCount">30</span></div>
    </div>

    <div class="action-bar">
      <button class="action-btn discard" id="discardBtn" disabled>Discard</button>
      <button class="action-btn draw-stock" id="drawStockBtn" disabled>Draw Stock</button>
      <button class="action-btn draw-discard" id="drawDiscardBtn" disabled>Draw Discard</button>
      <button class="action-btn lakdi" id="lakdiBtn" disabled title="Available after 1st turn">Call Lakdi</button>
    </div>

    <div class="player-hand" id="playerHand"></div>
  </div>

  <!-- SHOWDOWN -->
  <div id="showdownModal" class="modal hidden">
    <div class="modal-content">
      <h2>Round Results</h2>
      <div class="hands-grid" id="handsGrid"></div>
      <button class="btn btn-primary" id="closeShowdownBtn">Continue</button>
    </div>
  </div>

  <!-- GAME OVER -->
  <div id="gameOverModal" class="modal hidden">
    <div class="modal-content">
      <h2>Game Over!</h2>
      <div id="finalResults"></div>
      <button class="btn btn-primary" id="newGameBtn">New Game</button>
    </div>
  </div>

  <script>
    // ======= Local "rooms" (demo) =======
    const ROOMS_KEY='lakdi_rooms', POLL_INTERVAL=1000;
    const suitSym={hearts:"‚ô•", diamonds:"‚ô¶", clubs:"‚ô£", spades:"‚ô†"};
    const isRed = s => (s==='hearts'||s==='diamonds');
    const getRooms=()=>JSON.parse(localStorage.getItem(ROOMS_KEY)||'{}');
    const saveRooms=r=>localStorage.setItem(ROOMS_KEY,JSON.stringify(r));
    const genId=()=> 'player_'+Date.now()+'_'+Math.random().toString(36).slice(2,6);
    const genCode=()=> Math.random().toString(36).slice(2,8).toUpperCase();

    // ======= State =======
    let gameState = {
      players: [], myPlayerId:null, myHand:[], selectedCards:[], currentTurn:null,
      gamePhase:'waiting', discardPile:[], stockCount:0, roomCode:null, isHost:false,
      firstTurn:true, turnTimer:null, endThreshold:200, isSinglePlayer:false,
      aiPlayers:[], deck:[]
    };
    let pollTimer=null;

    // ======= AI =======
    class AIPlayer {
      constructor(id,name,level='medium'){ this.id=id; this.name=name; this.level=level; this.hand=[]; this.score=0; }
      chooseDiscard(){
        const hand=this.hand, ranks={};
        hand.forEach((c,i)=>{ (ranks[c.rank]??=[]).push(i); });
        // prefer pairs/triples
        for(const r in ranks){ if(ranks[r].length>=2) return ranks[r].slice(0,3); }
        // else highest single
        let hi=0,v=val(hand[0].rank);
        for(let i=1;i<hand.length;i++){ const x=val(hand[i].rank); if(x>v){v=x;hi=i;} }
        return [hi];
      }
      chooseDraw(discardTop){
        if(!discardTop) return 'stock';
        const v = val(discardTop.rank);
        if(this.level==='easy') return Math.random()<.5?'stock':'discard';
        if(this.level==='medium') return v<=4?'discard':'stock';
        // hard-ish: prefer discard if <=3
        return v<=3?'discard':'stock';
      }
      shouldLakdi(){
        if (gameState.firstTurn) return false;
        const t = total(this.hand);
        if(this.level==='easy') return t<=8;
        if(this.level==='medium') return t<=6;
        return t<=5;
      }
    }

    // ======= Helpers =======
    const val = r => (r==='A')?1 : (r==='J')?11 : (r==='Q')?12 : (r==='K')?13 : parseInt(r,10);
    const total = hand => hand.reduce((s,c)=>s+val(c.rank),0);
    const cardText = c => `${c.rank}${suitSym[c.suit]}`;

    // ======= UI refs =======
    const $ = id => document.getElementById(id);
    const setStatus = (msg,type='status')=>{
      const el=$('loginMessage'), el2=$('lobbyMessage');
      if(!$('loginScreen').classList.contains('hidden')){ el.textContent=msg; el.className = type==='error'?'error-message':'status-message'; }
      else if(!$('lobbyScreen').classList.contains('hidden')){ el2.textContent=msg; el2.className = type==='error'?'error-message':'status-message'; }
    };

    // ======= Single Player =======
    function startSinglePlayer(){
      const name=$('playerName').value.trim();
      if(!name){ setStatus('Please enter your name','error'); return; }
      gameState.isSinglePlayer=true;
      gameState.myPlayerId=genId(); gameState.isHost=true; gameState.roomCode='SINGLE';
      gameState.players=[{id:gameState.myPlayerId,name,score:0,isHost:true,connected:true}];
      // add 3 AI
      const AInames=[['Asha','easy'],['Bala','medium'],['Chetan','hard']];
      gameState.aiPlayers = AInames.map(([n,l],i)=> new AIPlayer('ai_'+i,`${n} (${l})`,l));
      gameState.players.push(...gameState.aiPlayers.map(ai=>({id:ai.id,name:ai.name,score:ai.score})));
      buildDeck();
      dealAll();
      // initial discard
      const top=gameState.deck.pop(); gameState.discardPile=[top];
      gameState.stockCount=gameState.deck.length; gameState.currentTurn=gameState.myPlayerId; gameState.firstTurn=true;
      showGame();
      startTurnTimer();
    }

    function buildDeck(){
      const suits=['hearts','diamonds','clubs','spades'];
      const ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
      gameState.deck=[];
      const decks = Math.ceil(gameState.players.length/6);
      for(let d=0; d<decks; d++){
        for(const s of suits) for(const r of ranks) gameState.deck.push({suit:s,rank:r});
      }
      for(let i=gameState.deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [gameState.deck[i],gameState.deck[j]]=[gameState.deck[j],gameState.deck[i]]; }
    }
    function dealAll(){
      gameState.myHand=[]; for(let i=0;i<3;i++) gameState.myHand.push(gameState.deck.pop());
      gameState.aiPlayers.forEach(ai=>{ ai.hand=[]; for(let i=0;i<3;i++) ai.hand.push(gameState.deck.pop()); });
    }

    // ======= Lobby (local demo) =======
    function createRoom(){
      const name=$('playerName').value.trim(); if(!name){ setStatus('Please enter your name','error'); return; }
      const rooms=getRooms(); const code=genCode(); const hostId=genId();
      rooms[code]={ host:hostId, players:[{id:hostId,name,score:0,connected:true,isHost:true,lastSeen:Date.now()}], gamePhase:'lobby', endThreshold:200, created:Date.now(), lastActivity:Date.now() };
      saveRooms(rooms);
      gameState.myPlayerId=hostId; gameState.roomCode=code; gameState.isHost=true; showLobby(); startPolling();
      setStatus('Room created! Share the code.');
    }
    function joinOrCreateRoom(){
      const name=$('playerName').value.trim(), code=($('roomCode').value||'').trim().toUpperCase();
      if(!name){ setStatus('Please enter your name','error'); return; }
      if(code && code.length!==6){ setStatus('Room code must be 6 characters','error'); return; }
      if(code) {
        const rooms=getRooms(), room=rooms[code]; if(!room){ setStatus('Room not found','error'); return; }
        if(room.gamePhase!=='lobby'){ setStatus('Game already in progress','error'); return; }
        if(room.players.some(p=>p.name.toLowerCase()===name.toLowerCase())){ setStatus('Name already taken','error'); return; }
        const id=genId(); room.players.push({id,name,score:0,connected:true,isHost:false,lastSeen:Date.now()}); room.lastActivity=Date.now(); saveRooms(rooms);
        gameState.myPlayerId=id; gameState.roomCode=code; gameState.isHost=false; showLobby(); startPolling(); setStatus('Joined room!');
      } else { createRoom(); }
    }
    function startPolling(){ clearInterval(pollTimer); pollTimer=setInterval(pollRoom, POLL_INTERVAL); pollRoom(); }
    function stopPolling(){ if(pollTimer){ clearInterval(pollTimer); pollTimer=null; } }
    function pollRoom(){
      if(!gameState.roomCode || !gameState.myPlayerId) return;
      const rooms=getRooms(), room=rooms[gameState.roomCode]; if(!room){ setStatus('Room no longer exists','error'); return; }
      // activity
      const me=room.players.find(p=>p.id===gameState.myPlayerId); if(me){ me.lastSeen=Date.now(); me.connected=true; room.lastActivity=Date.now(); }
      // prune
      const now=Date.now(); room.players = room.players.filter(p=> (p.id===gameState.myPlayerId) || (now - (p.lastSeen||0) < 30000));
      saveRooms(rooms);
      // sync
      gameState.players=room.players; gameState.gamePhase=room.gamePhase; gameState.endThreshold=room.endThreshold;
      updateLobbyUI();
      if(room.gamePhase==='playing'){ // sync minimal demo state
        if(room.currentTurn) gameState.currentTurn=room.currentTurn;
        if(room.stockCount!==undefined) gameState.stockCount=room.stockCount;
        if(room.discardTop) gameState.discardPile=[room.discardTop];
        if(room.firstTurn!==undefined) gameState.firstTurn=room.firstTurn;
        if(room.hands && room.hands[gameState.myPlayerId]) gameState.myHand=room.hands[gameState.myPlayerId];
        renderPlayers(); renderHand(); renderScores(); updateStock(); updateDiscard(); updateButtons();
        if(gameState.currentTurn===gameState.myPlayerId && !gameState.turnTimer) startTurnTimer();
      }
    }

    // ======= Start game (local lobby demo) =======
    function startGame(){
      if(!gameState.isHost || gameState.players.length<2) return;
      const rooms=getRooms(); const room=rooms[gameState.roomCode]; if(!room) return;
      room.endThreshold=parseInt($('endThreshold').value,10)||200;
      room.gamePhase='playing'; room.currentTurn=room.players[0].id; room.firstTurn=true;
      // quick random hands + discard (demo)
      const suits=['hearts','diamonds','clubs','spades']; const ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
      room.hands={}; room.players.forEach(pl=>{ room.hands[pl.id]=[]; for(let i=0;i<3;i++){ room.hands[pl.id].push({suit:suits[Math.floor(Math.random()*4)], rank:ranks[Math.floor(Math.random()*13)]}); }});
      room.discardTop={suit:'hearts',rank:'7'}; room.stockCount=52-(room.players.length*3);
      room.lastActivity=Date.now(); saveRooms(rooms);
      showGame();
    }

    // ======= UI switches =======
    function showLobby(){ $('loginScreen').classList.add('hidden'); $('lobbyScreen').classList.remove('hidden'); $('gameScreen').classList.add('hidden'); $('displayRoomCode').textContent=gameState.roomCode; $('hostControls').classList.toggle('hidden', !gameState.isHost); updateLobbyUI(); }
    function showGame(){ $('loginScreen').classList.add('hidden'); $('lobbyScreen').classList.add('hidden'); $('gameScreen').classList.remove('hidden'); renderAll(); }

    function updateLobbyUI(){
      $('playerCount').textContent=gameState.players.length;
      const list=$('playersList'); list.innerHTML='';
      gameState.players.forEach(p=>{
        const row=document.createElement('div'); row.className='player-item';
        row.innerHTML=`<span>${p.name} ${p.isHost?'üëë':''}</span><span>üü¢</span>`;
        list.appendChild(row);
      });
      if(gameState.isHost){
        const canStart=gameState.players.length>=2;
        $('startGameBtn').disabled=!canStart;
        $('startGameBtn').textContent=canStart?'Start Game':`Start Game (Need ${2-gameState.players.length} more players)`;
      }
      setStatus(gameState.players.length<2?`Share room code "${gameState.roomCode}" to invite.`:`${gameState.players.length} players ready. ${gameState.isHost?'Click Start!':'Waiting for host...'}`);
    }

    // ======= Render =======
    function renderPlayers(){
      const cont=$('playersContainer'); cont.innerHTML='';
      const others = gameState.players.filter(p=>p.id!==gameState.myPlayerId);
      others.forEach((p,i)=>{
        const seat=document.createElement('div'); seat.className=`player-seat ${gameState.currentTurn===p.id?'active':''}`;
        const handLen = (gameState.isSinglePlayer ? (gameState.aiPlayers.find(a=>a.id===p.id)?.hand.length||3) : 3);
        seat.innerHTML = `
          <div class="player-info">
            <div class="player-name">${p.name} ${p.isHost?'üëë':''}</div>
            <div class="player-score">${p.score||0} pts</div>
          </div>
          <div class="player-cards">${Array(handLen).fill(0).map(()=>'<div class="card-back"></div>').join('')}</div>
        `;
        cont.appendChild(seat);
      });
    }
    function renderHand(){
      const handDiv=$('playerHand'); handDiv.innerHTML='';
      gameState.myHand.forEach((c,idx)=>{
        const el=document.createElement('div'); el.className=`card ${isRed(c.suit)?'red':'black'} ${gameState.selectedCards.includes(idx)?'selected':''}`;
        el.textContent=cardText(c);
        el.onclick=()=>selectCard(idx);
        handDiv.appendChild(el);
      });
    }
    function renderScores(){
      const list=$('scoresList'); list.innerHTML='';
      const sorted=[...gameState.players].sort((a,b)=>(a.score||0)-(b.score||0));
      sorted.forEach(p=>{
        const it=document.createElement('div'); it.className=`score-item ${p.score===sorted[0].score?'winner':''}`;
        it.innerHTML = `<span>${p.name} ${p.isHost?'üëë':''}</span><span>${p.score||0}</span>`;
        list.appendChild(it);
      });
    }
    function renderAll(){ renderPlayers(); renderHand(); renderScores(); updateStock(); updateDiscard(); updateButtons(); }

    // ======= Selection rules: 1‚Äì3 of same rank =======
    function selectCard(i){
      if(gameState.currentTurn!==gameState.myPlayerId) return;
      if(gameState.myHand.length!==3) return;
      const already = gameState.selectedCards.includes(i);
      const rank = gameState.myHand[i].rank;
      if(already){
        gameState.selectedCards = gameState.selectedCards.filter(x=>x!==i);
      } else {
        // if adding first -> ok; if adding more, must match rank; max 3
        const curRanks = gameState.selectedCards.map(x=>gameState.myHand[x].rank);
        if(curRanks.length && curRanks[0]!==rank) gameState.selectedCards=[];
        if(gameState.selectedCards.length<3) gameState.selectedCards.push(i);
      }
      renderHand(); updateButtons();
    }
    function validDiscard(){
      const n=gameState.selectedCards.length; if(n===0||n>3) return false;
      if(n===1) return true;
      const r=gameState.myHand[gameState.selectedCards[0]].rank;
      return gameState.selectedCards.every(i=>gameState.myHand[i].rank===r);
    }

    // ======= Buttons enable =======
    function updateButtons(){
      const isMy=gameState.currentTurn===gameState.myPlayerId;
      const canDiscard = isMy && gameState.myHand.length===3 && validDiscard();
      const canDraw = isMy && gameState.myHand.length===2;
      const canLakdi = isMy && !gameState.firstTurn && gameState.myHand.length===3;
      $('discardBtn').disabled=!canDiscard;
      $('drawStockBtn').disabled=!canDraw;
      $('drawDiscardBtn').disabled=!(canDraw && gameState.discardPile.length>0);
      const lb=$('lakdiBtn'); lb.disabled=!canLakdi; lb.title = gameState.firstTurn?'Available after completing your first turn':'Call Lakdi to end the round';
    }

    // ======= Discard / Draw / Turns =======
    function discardSelected(){
      if(!validDiscard() || gameState.currentTurn!==gameState.myPlayerId) return;
      // remove selected, top of discard = last selected visually
      const indices=[...gameState.selectedCards].sort((a,b)=>a-b);
      const thrown = indices.map(i=>gameState.myHand[i]);
      for(let k=indices.length-1;k>=0;k--) gameState.myHand.splice(indices[k],1);
      gameState.discardPile=[thrown[thrown.length-1]];
      gameState.selectedCards=[];
      renderHand(); updateDiscard(); updateButtons();
    }
    function drawFromStock(){
      if(gameState.currentTurn!==gameState.myPlayerId || gameState.myHand.length!==2) return;
      // single player: draw real card; lobby demo: fake
      if(gameState.isSinglePlayer){
        if(!gameState.deck.length){ reshuffleFromDiscard(); }
        if(gameState.deck.length){
          gameState.myHand.push(gameState.deck.pop());
          gameState.stockCount=gameState.deck.length;
        }
      } else {
        // demo multiplayer-only front-end
        const suits=['hearts','diamonds','clubs','spades']; const ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        gameState.myHand.push({suit:suits[Math.floor(Math.random()*4)], rank:ranks[Math.floor(Math.random()*13)]});
        gameState.stockCount = Math.max(0,(gameState.stockCount||0)-1);
      }
      gameState.firstTurn=false; renderHand(); updateStock(); updateButtons(); endTurn();
    }
    function drawFromDiscard(){
      if(gameState.currentTurn!==gameState.myPlayerId || gameState.myHand.length!==2 || gameState.discardPile.length===0) return;
      gameState.myHand.push(gameState.discardPile.pop());
      gameState.firstTurn=false; renderHand(); updateDiscard(); updateButtons(); endTurn();
    }
    function reshuffleFromDiscard(){
      // if stock empty: shuffle discard pile (except top?) ‚Äî simple: just reuse whole pile
      if(gameState.discardPile.length>1){
        const keepTop = gameState.discardPile.pop();
        gameState.deck = [...gameState.discardPile];
        gameState.discardPile=[keepTop];
        for(let i=gameState.deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [gameState.deck[i],gameState.deck[j]]=[gameState.deck[j],gameState.deck[i]]; }
      }
    }

    function endTurn(){
      // move to next player
      const idx = gameState.players.findIndex(p=>p.id===gameState.currentTurn);
      const next = (idx+1)%gameState.players.length;
      gameState.currentTurn = gameState.players[next].id;
      renderPlayers(); updateButtons(); clearTimer();
      if(gameState.currentTurn===gameState.myPlayerId){ startTurnTimer(); }
      else if(gameState.isSinglePlayer){ aiTurn(); }
    }

    // ======= AI Turn (single player) =======
    function aiTurn(){
      const ai = gameState.aiPlayers.find(a=>a.id===gameState.currentTurn); if(!ai) return;
      setTimeout(()=>{
        // DISCARD
        const choice = ai.chooseDiscard(); // indices
        const thrown = choice.map(i=>ai.hand[i]);
        choice.sort((a,b)=>b-a).forEach(i=>ai.hand.splice(i,1));
        gameState.discardPile=[thrown[thrown.length-1]];
        updateDiscard();
        // DRAW
        setTimeout(()=>{
          const top = gameState.discardPile[gameState.discardPile.length-1];
          const draw = ai.chooseDraw(top);
          if(draw==='discard' && gameState.discardPile.length){
            ai.hand.push(gameState.discardPile.pop());
            updateDiscard();
          } else {
            if(!gameState.deck.length){ reshuffleFromDiscard(); }
            if(gameState.deck.length){ ai.hand.push(gameState.deck.pop()); gameState.stockCount=gameState.deck.length; updateStock(); }
          }
          // Decide Lakdi
          if(ai.shouldLakdi()){ return doLakdi(ai.id); }
          gameState.firstTurn=false; // after everyone‚Äôs first full turn
          // NEXT
          const idx = gameState.players.findIndex(p=>p.id===gameState.currentTurn);
          gameState.currentTurn = gameState.players[(idx+1)%gameState.players.length].id;
          renderPlayers(); updateButtons();
          if(gameState.currentTurn===gameState.myPlayerId) startTurnTimer(); else aiTurn();
        }, 700);
      }, 600);
    }

    // ======= Lakdi (showdown) =======
    function doLakdi(callerId){
      // collect hands
      const hands={};
      hands[gameState.myPlayerId]=[...gameState.myHand];
      gameState.aiPlayers.forEach(ai=>hands[ai.id]=[...ai.hand]);

      // compute totals
      const totals={};
      for(const pid in hands) totals[pid]=total(hands[pid]);

      // winner & cut rule:
      // Caller attempts Lakdi; any opponent with <= caller total can "cut":
      // If valid cut is called (button in multi; auto by opponents here), caller gets +50 flat.
      let winnerId = callerId;
      let penalties = {};
      let callerTotal = totals[callerId];
      // find lowest total overall
      let globalWinner = Object.entries(totals).sort((a,b)=>a[1]-b[1])[0][0];

      // if someone other than caller has <= caller total, it's a valid cut ‚áí caller +50 (flat)
      if(globalWinner!==callerId && totals[globalWinner] <= callerTotal){
        penalties[callerId]=50;
        winnerId = globalWinner;
      }

      // scoring: winner gets 0; others get sum; if penalty on caller add +50 flat
      gameState.players.forEach(p=>{
        if(p.id===winnerId){ /* +0 */ }
        else {
          const add = totals[p.id] + (penalties[p.id]||0);
          p.score = (p.score||0) + add;
          // mirror to AI objects
          const ai = gameState.aiPlayers.find(a=>a.id===p.id); if(ai) ai.score=p.score;
        }
      });

      // reveal showdown
      showShowdown({hands, totals, penalties, winnerId});
    }

    // ======= Showdown Modal =======
    function showShowdown({hands, totals, penalties, winnerId}){
      const grid=$('handsGrid'); grid.innerHTML='';
      gameState.players.forEach(p=>{
        const isWin = p.id===winnerId, pen = penalties[p.id]||0, t = totals[p.id]||0;
        const div=document.createElement('div'); div.className=`hand-display ${isWin?'winner':''} ${pen? 'penalty':''}`;
        const cardsHTML = (hands[p.id]||[]).map(c=>`<div class="mini-card ${isRed(c.suit)?'red':''}">${cardText(c)}</div>`).join('');
        div.innerHTML = `
          <div class="player-name">${p.name}</div>
          <div class="hand-cards">${cardsHTML}</div>
          <div class="hand-total">Total: ${t}${pen?` (+${pen})`:''}</div>
          ${isWin?'<div style="color:#2ecc71;font-weight:bold">Winner!</div>':''}
          ${pen?'<div style="color:#e74c3c;font-weight:bold">Cut Penalty +50</div>':''}
        `;
        grid.appendChild(div);
      });
      $('showdownModal').classList.remove('hidden');
    }
    $('closeShowdownBtn').onclick = () => {
      $('showdownModal').classList.add('hidden');
      // check end
      renderScores();
      const max = Math.max(...gameState.players.map(p=>p.score||0));
      if(max>=gameState.endThreshold) return showGameOver();
      // next round
      if(gameState.isSinglePlayer){
        dealAll();
        // fresh discard
        if(!gameState.deck.length){ reshuffleFromDiscard(); }
        if(gameState.deck.length){ gameState.discardPile=[gameState.deck.pop()]; gameState.stockCount=gameState.deck.length; }
        gameState.firstTurn=true; gameState.selectedCards=[]; gameState.currentTurn=gameState.players[0].id;
        renderAll(); startTurnTimer();
      } else {
        // demo-only: just randomize my hand
        const suits=['hearts','diamonds','clubs','spades']; const ranks=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        gameState.myHand=[]; for(let i=0;i<3;i++) gameState.myHand.push({suit:suits[Math.floor(Math.random()*4)], rank:ranks[Math.floor(Math.random()*13)]});
        gameState.firstTurn=true; gameState.selectedCards=[]; renderHand(); updateButtons();
      }
    };

    // ======= Game Over =======
    function showGameOver(){
      const res=$('finalResults');
      const sorted=[...gameState.players].sort((a,b)=>(a.score||0)-(b.score||0));
      const winner=sorted[0];
      res.innerHTML = `
        <h3>üèÜ ${winner.name} Wins!</h3>
        <div class="final-scores">
          ${sorted.map((p,i)=>`<div class="score-item ${i===0?'winner':''}"><span>${i+1}. ${p.name}</span><span>${p.score||0} points</span></div>`).join('')}
        </div>`;
      $('gameOverModal').classList.remove('hidden');
    }
    $('newGameBtn').onclick = () => window.location.reload();

    // ======= Timer =======
    function startTurnTimer(){
      clearTimer();
      let t=30; $('turnTimer').classList.remove('hidden'); $('timerCount').textContent=t;
      gameState.turnTimer = setInterval(()=>{
        t--; $('timerCount').textContent=t;
        if(t<=0){
          clearTimer(); $('turnTimer').classList.add('hidden');
          // auto: discard lowest single then draw stock
          if(gameState.currentTurn===gameState.myPlayerId && gameState.myHand.length===3){
            const idx = gameState.myHand.reduce((min,i,ix,arr)=> val(i.rank) < val(arr[min].rank) ? ix : min, 0);
            gameState.selectedCards=[idx]; discardSelected();
            setTimeout(()=>{ if(gameState.myHand.length===2) drawFromStock(); }, 600);
          }
        }
      },1000);
    }
    function clearTimer(){ if(gameState.turnTimer){ clearInterval(gameState.turnTimer); gameState.turnTimer=null; } }

    // ======= Stock/Discard display =======
    function updateStock(){ $('stockCount').textContent=gameState.stockCount||0; }
    function updateDiscard(){ const el=$('discardCard'); if(gameState.discardPile.length){ const top=gameState.discardPile.at(-1); el.textContent=cardText(top); } else el.textContent='Empty'; }

    // ======= Controls wiring =======
    $('joinButton').onclick = joinOrCreateRoom;
    $('createButton').onclick = createRoom;
    $('singleButton').onclick = startSinglePlayer;
    $('startGameBtn').onclick = startGame;
    $('discardBtn').onclick = discardSelected;
    $('drawStockBtn').onclick = drawFromStock;
    $('drawDiscardBtn').onclick = drawFromDiscard;
    $('lakdiBtn').onclick = ()=>{ if(!gameState.firstTurn && gameState.currentTurn===gameState.myPlayerId && gameState.myHand.length===3) doLakdi(gameState.myPlayerId); };

    $('stockPile').onclick = ()=>{ if(!$('drawStockBtn').disabled) drawFromStock(); };
    $('discardPile').onclick = ()=>{ if(!$('drawDiscardBtn').disabled) drawFromDiscard(); };

    // ======= Boot =======
    document.addEventListener('DOMContentLoaded',()=>{
      // prune stale rooms
      const rooms=getRooms(), now=Date.now(), hr=3600000;
      for(const k of Object.keys(rooms)){ if(now-(rooms[k].lastActivity||0)>hr) delete rooms[k]; } saveRooms(rooms);
      $('playerName').focus();
      $('playerName').addEventListener('keypress',e=>{ if(e.key==='Enter') $('roomCode').focus(); });
      $('roomCode').addEventListener('keypress',e=>{ if(e.key==='Enter') $('joinButton').click(); });
      $('roomCode').addEventListener('input',e=> e.target.value = (e.target.value||'').toUpperCase());
    });
  </script>
</body>
</html>
