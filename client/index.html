<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lakdi</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { margin:0; font-family:sans-serif; background:#0d2818; color:#fff }
    main { max-width:1100px; margin:auto; padding:20px }
    .hidden { display:none!important }
    .panel { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
      border-radius:14px; padding:14px; margin-bottom:14px }
    input { padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.3);
      background:rgba(255,255,255,.1); color:#fff }
    button { padding:8px 14px; border:none; border-radius:8px; cursor:pointer;
      font-weight:bold; margin:4px; background:#2563eb; color:#fff }
    button:disabled { opacity:.5; cursor:not-allowed }
    #playersList .player { display:flex; justify-content:space-between; align-items:center;
      margin:4px 0; padding:4px; border-radius:6px; background:rgba(255,255,255,.05) }
    .backs { display:flex; gap:2px }
    .back { width:14px; height:20px; background:linear-gradient(135deg,#2c3e50,#34495e);
      border:1px solid #3498db; border-radius:2px }
    .card { display:inline-flex; align-items:center; justify-content:center; min-width:80px;
      height:108px; background:#fff; color:#111; border:2px solid #cbd5e1; border-radius:10px;
      cursor:pointer; margin:4px }
    .card.selected { transform:translateY(-8px); border-color:#0ea5e9; background:#f0f9ff }
    .card.red { color:#e74c3c }
    #log { white-space:pre; background:#111; color:#0f0; padding:10px; border-radius:8px;
      max-height:200px; overflow:auto }
    /* Showdown */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.7); display:flex;
      align-items:center; justify-content:center }
    .modal .content { background:#143828; border:1px solid rgba(255,255,255,.2);
      border-radius:14px; max-width:960px; width:92%; padding:16px; max-height:85vh; overflow:auto }
    .hands { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:10px }
    .handBox { background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.1);
      border-radius:12px; padding:10px }
    .handBox.winner { border-color:#10b981; background:rgba(16,185,129,.25) }
    .handBox.penalty { border-color:#e74c3c; background:rgba(231,76,60,.25) }
    .mini { width:60px; height:84px; background:#fff; color:#111; border:2px solid #cbd5e1;
      border-radius:8px; display:flex; align-items:center; justify-content:center;
      font-weight:800; margin:2px }
    .mini.red { color:#e74c3c }
  </style>
</head>
<body>
<main>
  <h1>üÉè Lakdi</h1>

  <!-- Lobby -->
  <section id="lobby" class="panel">
    <input id="playerName" placeholder="Your name" />
    <button id="createBtn">Create Room</button>
    <input id="roomCode" placeholder="Room code" />
    <button id="joinBtn">Join Room</button>
    <div id="lobbyMsg"></div>
  </section>

  <!-- Game -->
  <section id="table" class="hidden">
    <div id="playersPanel" class="panel">
      <div>Room: <span id="roomCodeDisplay"></span></div>
      <button id="startBtn">Start</button>
      <div id="playersList"></div>
      <div>
        <button id="discardBtn" disabled>Discard</button>
        <button id="drawStockBtn" disabled>Draw Stock</button>
        <button id="drawDiscardBtn" disabled>Draw Discard</button>
        <button id="lakdiBtn" disabled>Call Lakdi</button>
        <button id="cutBtn" disabled>Cut</button>
        <button id="passBtn" disabled>Pass</button>
        <button id="nextRoundBtn" disabled>Next Round</button>
      </div>
    </div>
    <div class="panel">
      <h3>Your Hand</h3>
      <div id="hand"></div>
      <h3>Log</h3>
      <pre id="log"></pre>
    </div>
  </section>

  <!-- Showdown -->
  <div id="showdownModal" class="modal hidden">
    <div class="content">
      <h2>Round Results</h2>
      <div id="showdownInfo"></div>
      <div class="hands" id="handsGrid"></div>
      <button id="closeShowdown">Close</button>
    </div>
  </div>
</main>

<script>
const socket = io("https://lakdi.onrender.com",{transports:["polling","websocket"]});
let me=null, room=null, selected=[], hasDiscarded=false;

const $=id=>document.getElementById(id);
const log=(...a)=>{ $("log").textContent+=a.join(" ")+"\\n"; $("log").scrollTop=$("log").scrollHeight; };
const color=s=>s==="hearts"||s==="diamonds"?"red":"black";

function renderHand(){
  const h=room.hands?.[me.id]||[]; const d=$("hand"); d.innerHTML="";
  h.forEach(c=>{
    const e=document.createElement("div"); e.className="card "+color(c.suit);
    e.textContent=c.rank+" "+c.suit;
    if(selected.find(x=>x.rank===c.rank&&x.suit===c.suit)) e.classList.add("selected");
    e.onclick=()=>{ 
      const i=selected.findIndex(x=>x.rank===c.rank&&x.suit===c.suit);
      if(i>=0) selected.splice(i,1); else selected.push(c); 
      renderHand();
    };
    d.appendChild(e);
  });
}
function renderPlayers(){
  const ul=$("playersList"); ul.innerHTML="";
  (room.players||[]).forEach(p=>{
    const row=document.createElement("div"); row.className="player";
    const left=document.createElement("span"); left.textContent=`${p.name} (${p.score})`;
    const right=document.createElement("span");
    const backs=document.createElement("span"); backs.className="backs";
    const hand=room.hands?.[p.id]||[];
    for(let i=0;i<hand.length;i++){ backs.appendChild(document.createElement("span")).className="back"; }
    const badge=document.createElement("span"); badge.textContent=`${hand.length} cards`;
    right.appendChild(backs); right.appendChild(badge);
    row.appendChild(left); row.appendChild(right);
    ul.appendChild(row);
  });
}
function render(){ if(!room)return; renderPlayers(); renderHand(); }

// --- showdown rendering
function showShowdown(summary){
  $("showdownModal").classList.remove("hidden");
  const grid=$("handsGrid"); grid.innerHTML="";
  const info=$("showdownInfo");
  const winnerName=room.players.find(p=>p.id===summary.winnerId)?.name||"";
  info.textContent=`Winner: ${winnerName}`;
  room.players.forEach(p=>{
    const hb=document.createElement("div"); hb.className="handBox";
    if(summary.winnerId===p.id) hb.classList.add("winner");
    if(summary.penalties[p.id]===50) hb.classList.add("penalty");
    const title=document.createElement("div");
    title.innerHTML=`<strong>${p.name}</strong> ‚Äî round score: ${summary.penalties[p.id]}`;
    const minis=document.createElement("div");
    (room.hands[p.id]||[]).forEach(c=>{
      const m=document.createElement("div"); m.className="mini "+color(c.suit);
      m.textContent=c.rank+" "+c.suit;
      minis.appendChild(m);
    });
    hb.appendChild(title); hb.appendChild(minis);
    grid.appendChild(hb);
  });
}
$("closeShowdown").onclick=()=>{ $("showdownModal").classList.add("hidden"); };

// --- Lobby buttons
$("createBtn").onclick=()=>{
  const name=$("playerName").value||"Player";
  socket.emit("create_room",{name},res=>{
    if(res?.error){ $("lobbyMsg").textContent=res.error; return; }
    me=res.me; $("roomCodeDisplay").textContent=res.code;
    $("lobby").classList.add("hidden"); $("table").classList.remove("hidden");
  });
};
$("joinBtn").onclick=()=>{
  const name=$("playerName").value||"Player";
  const code=($("roomCode").value||"").trim().toUpperCase();
  socket.emit("join_room",{code,name},res=>{
    if(res?.error){ $("lobbyMsg").textContent=res.error; return; }
    me=res.me; $("roomCodeDisplay").textContent=res.code;
    $("lobby").classList.add("hidden"); $("table").classList.remove("hidden");
  });
};

// --- Buttons
$("startBtn").onclick=()=> socket.emit("start_game",{code:room?.code,endThreshold:200});
$("discardBtn").onclick=()=> socket.emit("discard",{code:room.code,cards:selected},()=>{hasDiscarded=true;selected=[];});
$("drawStockBtn").onclick=()=> socket.emit("draw",{code:room.code,source:"stock"},()=>{hasDiscarded=false;});
$("drawDiscardBtn").onclick=()=> socket.emit("draw",{code:room.code,source:"discard"},()=>{hasDiscarded=false;});
$("lakdiBtn").onclick=()=> socket.emit("call_lakdi",{code:room.code});
$("cutBtn").onclick=()=> socket.emit("cut",{code:room.code});
$("passBtn").onclick=()=> socket.emit("pass_cut",{code:room.code});
$("nextRoundBtn").onclick=()=> socket.emit("next_round",{code:room.code});

// --- Socket
socket.on("room_state",st=>{ room=st; if(!me) me=st.players.find(p=>p.id===socket.id); render(); });
socket.on("showdown_summary",s=> showShowdown(s));
socket.on("connect",()=> log("Connected:",socket.id));
socket.on("connect_error",err=> log("connect_error",err.message||err));
</script>
</body>
</html>
